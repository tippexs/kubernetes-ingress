
name: Run Smoke Tests
description: Run Smoke Tests for the project

inputs:
  k8s-version:
    description: Kubernetes version to use
    required: false
  image:
    description: Docker image to use
    default: debian
    required: false
  marker:
    description: Marker to use
    required: false
  nginx-key:
    description: Nginx key to use
    required: false
  nginx-crt:
    description: Nginx cert to use
    required: false

outputs:
  test-results-name:
    description: Test results name
    value: tests-${{ steps.k8s.outputs.cluster }}

runs:
  using: composite
  steps:
    - name: Fetch Cached Artifacts
      uses: actions/cache@v2
      with:
        path: ${{ github.workspace }}/dist
        key: nginx-ingress-${{ github.run_id }}-${{ github.run_number }}-single

    - name: Ingress type
      id: ingress-type
      run: |
        plus=""
        if [[ ${{ inputs.image }} == *plus* ]]; then
          plus="-plus"
        fi
        echo ::set-output name=name::nginx$plus-ingress
      shell: bash

    - name: Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build ${{ inputs.image }} Container
      uses: docker/build-push-action@v2
      with:
        file: build/Dockerfile
        context: '.'
        cache-from: type=gha,scope=${{ inputs.image }}
        cache-to: type=gha,scope=${{ inputs.image }},mode=max
        target: goreleaser
        tags: 'docker.io/nginx/${{ steps.ingress-type.outputs.name }}:${{ inputs.image }}-${{ github.sha }}'
        load: true
        pull: true
        build-args: BUILD_OS=${{ inputs.image }}
        secrets: |
          "nginx-repo.crt=${{ inputs.nginx-crt }}"
          "nginx-repo.key=${{ inputs.nginx-key }}"

    - name: Deploy Kubernetes
      id: k8s
      run: |
        minikube start --kubernetes-version=v${{ inputs.k8s-version }} --wait=all --memory 4096
        minikube image load docker.io/nginx/${{ steps.ingress-type.outputs.name }}:${{ inputs.image }}-${{ github.sha }}
        echo ::set-output name=cluster_ip::$(minikube ip)
        echo ::set-output name=cluster::$(echo nginx-${{ inputs.image }}-${{ inputs.marker != '' && inputs.marker || inputs.k8s-version }})
      working-directory: ./tests
      shell: bash

    - uses: actions/setup-python@v2
      with:
        python-version: '3.x'
        # cache: 'pip'
        # cache-dependency-path: '**/requirements.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r tests/requirements.txt
      shell: bash

    - name: Run Smoke Tests
      run: |
        touch tests-${{ steps.k8s.outputs.cluster }}.html
        python -m pytest \
        --image=docker.io/nginx/${{ steps.ingress-type.outputs.name }}:${{ inputs.image }}-${{ github.sha }} \
        --image-pull-policy=Never \
        --ic-type=${{ steps.ingress-type.outputs.name }} \
        --service=nodeport --node-ip=${{ steps.k8s.outputs.cluster_ip }} \
        --html=tests-${{ steps.k8s.outputs.cluster }}.html \
        --self-contained-html \
        --show-ic-logs=yes --profile -vv -l -x -ra \
        -m ${{ inputs.marker != '' && inputs.marker || '""' }}
      working-directory: ./tests
      shell: bash
